## 第八章
### 数据库设计概述

* 什么是数据库设计：数据库设计是指对于一个给定的应用环境，构造（设计）优化**数据库逻辑模式和物理结构**，并据此建立数据库及其应用系统，使之能够有效的存储数据，满足各种用户的应用需求，包括信息管理要求和**数据操作**要求
* 数据库设计的目的：数据共享，为用户和各种应用系统提供一个信息基础设施和高效率的运行环境
* 数据库设计的
    * 特点：三分技术，七分管理，十二分基础数据
* 手工共与经验相结合的方法
    * 设计质量与设计人员的经验和水平有直接关系，它使数据库设计成为一种以上述而不是工程技术
    * 数据库运行一段时间后常常有不同程度地发现各种问题，增加了维护代价
* 典型的规范设计方法
    * 新奥尔良方法：将数据库设计分为若干个阶段
    * 基于E-R模型的数据库设计方法：概念设计阶段**广泛采用**
    * 基于3NF的设计方法：逻辑阶段可采用的有效方法
    * ODL的设计方法：面向对象的数据库设计方法
#### 数据库设计的基本步骤

* 需求分析阶段
    * 准确了解与分析用户需求（包括数据与处理）
    * 设计过程中的基础，也是最困难、最耗时间的一步
* 概念结构设计阶段
    * 是整个数据库设计的关键
    * 通过对用户需求进行综合、归纳与抽象，形成一个独立于具体DBMS的概念模型
* 逻辑结构设计阶段
    * 将概念结构转换为某个DBMS所支持的数据模型，如关系模型，形成数据库逻辑模式；根据用户处理的要求、安全性的考虑，在基本的表基础上在建立必要的视图，形成数据库的外模式
    * 对其进行优化
* 数据库物理设计阶段
    * 为逻辑数据模型选取一个最适合应用环境的物理结构，根据DBMS特点和处理的需要，进行物理存储安排，建立索引，形成数据库内模式
* 数据库实施阶段
    * 运用DBMS提供的数据语言、工具及宿主语言，根据逻辑设计和物理设计的结果:
        * 建立数据库
        * 编制与调试应用程序
        * 组织数据入库
        * 并进行试运行
* 数据库运行和维护阶段
    * 数据库应用系统经过试运行后即可投入正式运行。
    * 在数据库系统运行过程中必须不断地对其进行评价、调整与修改。
### 需求分析

* 调查过程：本质是对数据流程的调查
* 传统的系统调查方法有：
    * 资料手机
    * 访谈
    * 实地观察
    * 问卷调查
* 事件与系统需求
* 时间类型：
    * 外部事件：在系统之外发生，通常由外部的人或组织激发的事件，这些人或组织是数据的提供者和接收者
        * 寻找外部事件：
            * 确定外部实体，分析
            * 外部实体需要一个事务处理
            * 外部实体需要系统提供某些信息
            * 某些数据改变了，系统需要更新它们
            * 管理过程需要某些信息
    * 时间事件：时间自动触发，即当系统事件达到某一刻是发生的事件，这些事件通常要求系统能定时地完成某些输出或处理
        * 注意：命名时必须包含所要完成的**处理和规定期限**
    * 状态事件：系统内部的变化触发系统对某个处理的需要，这种情况的发生称为状态事件
        * 状态事件一般是外部事件的结果，它的发生是不定时的
* 识别时间的规则
    * 区分时间与具体响应过程
    * 跟踪关键业务的整个生命周期来发现事件
    * 暂时忽略技术性依赖事件和系统控制事件
* 事务类型
* 事务之间的关系
* 事务之间关系基数
* 事务属性：能唯一区别事务
* 需求定义
    * 需求分析是分析人员与用户反复沟通和谈判的过程
    * 需求定义就是在各方就系统需求达成一致意见后，整理并把需求表示出来，详细定义和描述每项需求，确认约束条件及限制，编写相关文档说明书
    * 需求定义：
        * 自然语言
        * 模型定义
 * 定义和表示需求常用的建模工具：
     * 流程建模
         * 业务流程（业务流程图/UML活动图）
         * 数据处理流程（数据流程图、数据字典）
     * 用例建模
         * 信息系统功能模型（UML用例图）
     * 领域对象建模
         * 领域对象模型（UML类图、UML状态图）  
#### 数据流图

* 数据流程图（DFD）
![avatar](http://118.31.20.205:8888/images/8.1.png)
*  基本符号
    *  Gane-Sarson甘恩-萨森画法
    ![avatar](http://118.31.20.205:8888/images/8.2.png)
    *  外部实体：指系统以外又与系统有联系的人或者事务。它表达了该系统数据的外部来源和去处
        *  外部实体是数据得来源
        *  外部实体是数据的去处
    *  数据处理：对数据的逻辑处理功能
        *  功能、处理过程、数据加工
         ![avatar](http://118.31.20.205:8888/images/8.3.png)
    * 数据流：指处理过程的输入或输出（箭头表示数据流向）
    ![avatar](http://118.31.20.205:8888/images/8.4.png)
    *  数据存储：表示某种数据保存后的逻辑同城，不是指保存数据  的物理地点或物理介质
        *  数据存储的数据流：将处理后的数据**写入或修改**到数据存储中
        *  数据存储的数据流：从数据存储中**查询**获得数据，不改变原来的数据     
* 数据流程图的绘制方法
    * 理解系统的业务流程-->称为业务专家
    * 寻找系统中的事件-->找到系统单个功能（数据流图片段，表达单个数据处理功能）
    * 归纳并重构系统的处理流程图-->构造系统完整功能(完整数据流图)
* 绘制数据流图的注意事项
    * 合理的层次划分
        * 展开的层次与管理层次一直，也可以划分的更仔细
        * 同一张图上的所有处理过程应尽可能处于同一个抽象层次上
        * 一个处理框经过展开，一半以分解为4~10处理框为宜
            * 如果一次分解后仅有**两个处理框**，为减少数据流图的层次，可以将他们直接并入上一层中。
            * 一个处理框分解后还是只有**一个处理**框，而视为无效的分解
        *  最下层的处理过程用几句话，或者几张判定表，或一张见到那的HIPO图能表达清楚
    * 正确性的检查
        * 数据守恒（输入输出数据是否匹配）
        * 数据存储：必定有流入的数据和流出的数据
        * 父图中某一处理框的输入、输出数据必须出现在相应子图中
        * 任何一个数据流至少有一端是处理框
    * 可读性
        * 利用数据村属简化处理间的联系
        * 每层的处理框需要均匀分解，齐头并进
        * 适当命名
    * 确定系统边界
        * 管理模型-->信息处理模型-->计算机程序
        * 信息处理模型需要从业务处理中抽象出数据处理过程
        * 因此要关注信息系统解决的问题，重点是系统中的数据处理和流动并考虑人机分工
* 数据流图优点：
    * 图形元素少，易学易读，容易与用户沟通
    * 有层次性，允许系统分析员由上至下逐步分析系统，不会受困于天多复杂的细节
* 数据流图缺点：
    * 不能描述系统的控制流
    * 潜在的非语法错误不易发现，复核困难，需要有一定的额分析设计经验
* 数据字典：
    * 为什么要建立数据字典：
        * 数据流图表达不够准确、具体，只有将每个成分都给给出定义之后，才能完整、准确地描述一个系统
        * 建立数据字典来对数据流图的各个元素作出详细的说明
    * 数据字典的作用：
        * 有助于改进系统分析员和用户之间的通信，从而消除他们直间的许多误解
        * 有助于改进在不通的开发人员或不同的开发小组之间的通信，加快系统开发的进度
        * 是开发数据库的第一步，而且是很有价值的一步
### 概念结构设计

* 概念结构设计：将需求分析得到的用户的需求抽象为信息结构即概念模型的过程
    * 是各种数据模型的共同基础、它比数据模型更独立于及其、更抽象，从而更加稳定
    * 是整个数据库设计的关键
* 设计步骤
    * 设计局部E-R图
    * 综合成初步E-R图
    ![avatar](http://118.31.20.205:8888/images/8.5.png)
    * 优化成基本E-R图
* 设计常用策略
    * 自底向上地设计概念结构
        * 抽象数据并设计局部视图
        * 集成局部视图，得到全局概念结构

### 逻辑结构设计
![avatar](http://118.31.20.205:8888/images/8.6.png)

* E-R图向关系模型的转换（模型转化为二维表）
    * 如何将实体和实体间的关系转换为关系模式
        * 关系的属性：实体型的属性
        * 关系的码：实体型的码
    * 一个m:n联系转换为一个关系模式
        *     关系得属性：与该联系相连的各实体的主码以及联系本身的属性
        *     关系的主码：各实体主码的组和
    * 一个1：n联系可以转换为一个独立的关系模式，也可以与n端对应的关系模式合并  
        * 转换为一个独立的关系模式
            * 关系的属性：与该联系相连的各实体的主码以及联系本身的属性
            * 关系的主码：  n端实体的主码
        * 与n端对应的关系模式合并
            * 合并后关系的属性：在n端关系中假如1端关系的主码和联系本身的属性
            * 合并后关系的主码：不变
    * 一个1:1联系可以转换为一个独立的关系模式，也可以与任意一端对应的关系模式合并 
        * 转换为一个独立的关系模式
            * 关系的属性：与该联系相连的各实体的主码以及联系本身的属性
            * 关系的候选码：每个实体的主码均是该关系的候选码
        * 与 某一段对应的关系模式合并
            * 合并后关系的属性：假如对应关系的主码和联系本身的属性
            * 合并后关系得主码：不变
    * 三个或三个以上实体间的一个多元联系转换为一个关系模式
        * 关系的属性：与该多元联系相连的各个实体的主码以及联系本身的属性
        * 关系的主码：各实体主码的组和
    * 具有相同码的关系模式可合并
        * 目的：减少系统中关系个数
        * 合并方法：将其中一个关系模式的全部属性加入到另一个关系模式中，然后去掉其中的同义属性，并适当调整属性的次序  
    * 如何确定这些关系模式的属性和码
* 逻辑模型设计的结果不唯一
    * 得到初步数据模型后,还应当适当的去修改、调整数据模型的结构，以进一步提高数据库应用系统的行能，这就是数据模型的优化
    * 关系数据模型的优化通常以规范化理论为指导
* 优化方法：
    * 确定依赖
    * 消除冗余
    * 确定所属范式
    * 分析是否适合数据库应用环境
    * 对模式进行必要分解，提高数据操作效率和存储空间利用率
        * 水平分解：把（基本）关系的元组分解为若干子集合，定义每个子集合为一个子关系，以提高系统的效率
        * 垂直分解：把关系模式R的属性分解为若干子集合，形成若干个子关系模式
            * 前提：分解后数据库效率可以得到提高

### 物理结构设计

* 什么是数据库的物理设计：
    * 数据库在物理设备上的存储结构与存取方法称为数据库的物理结构，它依赖于给定的计算机系统
    * 为一个给定的逻辑数据模型选区一个最适合应用环境的物理结构的过程，就是数据库的物理设计
* 设计步骤
    * 确定数据库的理论结构，在关系数据库中主要指存取方法和存储结构
    * 对物理结构进行评价，评价的重点是时间效率和空间效率
* DBMS常用存取方法：
    * 索引法：
        * B+树索引
            * 需要确定：对哪些属性列建立索引？对哪些属性列建立组合索引？对哪些索引要设计为唯一索引
            * 索引过多的话 维护、查找索引会带来很大消耗
        * hash索引
    * 聚簇方法 
        * 概念：为了提高某个属性或属性组的查询速度，把这个或者这些属性上具有相同值得元组集中存放在连续得物理块中称为聚簇
        ![avatar](http://118.31.20.205:8888/images/8.7.png)
        * 用途：
            * 大大提高聚簇属性查询的效率
            * 节省存储空间
        * 局限性：
            * 只能提高某些特定应用的行能 
            * 建立与维护时的开销相当大
 * 确定数据库的物理结构:存储结构和存放位置
     * 确定数据的存放位置
         * 硬件环境
         * 应用需求： 存取事件、存储空间利用率、维护代价。
         * 基本原则：分开存放
             * 易变部分与稳定部分
             * 存取频率较高部分与存取效率较低部分

### 数据库的实施与维护

* 数据库的实施：（用SQL语句建表）
    * 用DDL定义数据库结构
    * 组织数据入库
    * 编制与调试应用程序
    * 数据库试运行
* 运行维护
    * 需要不断进行优化 长期进行
    **小结**
    ![avatar](http://118.31.20.205:8888/images/zj8.png)

## 第九章数据库的并发与恢复
### 并发控制
![avatar](http://118.31.20.205:8888/images/9.1.png)

* 事务是数据库中执行的一个工作单位，它是由用户定义的一组操作序列
* 一个事务可以是一组SQL语句、一条SQL语句或整个程序，一个应用程序可以包括多个事务
* 定义事务语句：
    * BEGIN TRANSACTION 事务的开始
    * COMMIT 事务的提交
    * ROLLBACK 事务的回滚
* 事务的特性：
    * 原子性：不做或者全做，不允许只完成部分
    * 一致性：指数据库中的数据满足完整性约束、
    * 隔离性：如果多个事务并发执行，应有独立空间互不打扰
    * 持久性：事务一旦提交，数据应该具有持久性，即使数据库受到破坏，DBMS也应该能够恢复
* 并发后果：
    * 丢失更新：
  ![avatar](http://118.31.20.205:8888/images/9.2.png)
    * 污读
  ![avatar](http://118.31.20.205:8888/images/9.3.png)
    * 不可重读
  ![avatar](http://118.31.20.205:8888/images/9.4.png)
* 实现并发控制的方法：
    * 封锁技术
        * 概念：就是当一个事务在对某个数据对象进行操作之前必须获得相应的锁，以保证数据操作的正确性和唯一性
        * 锁的类型
            * 排它锁（封锁）：简称为X封锁，它采用的原理时禁止并发操作
            * 共享锁（读锁）：简称为S锁，它允许用户读取，但是不允许修改
        * 一级封锁协议：t1先上X锁 此时t2只有等t1完成事务时才能上锁
        * 二级封锁协议：在一级封锁基础上的等t1事务回滚完成t2上Ssuo读取事务此时就可以避免污读
        * 三级封锁协议：在一级封锁协议的基础上，另外加上事务t1在读取数据R之前必须先对其加S锁，读完之后不立马释放，而指导事务T结束才释放
        * 封锁粒度（封锁单位）：可以是：字段、记录、表、数据库
        ![avatar](http://118.31.20.205:8888/images/9.5.png)
        *  活锁：当某个事物请求对某一数据进行排它性封锁时，由于其他事物对该数据的操作而使这个十五处于永久等待状态，这种中泰称为活锁
        *  死锁：在同时处于等待状态的两个或者多个事务中，其中的每一个在它能够进行之前，都等待着某个数据，而这个数据已被他们中的某个事物所封锁这种状态称为死锁 
        *  死锁预防：
            *  一次加锁法：一次性对所有资源加锁，如果有一个资源无法加锁，则等待
            *  顺序加锁法：规定的序号，按序号加锁         
    * 时标技术    
      ![avatar](http://118.31.20.205:8888/images/9.6.png)


### 数据库恢复

* 含义：将数据库从错误状态转换为正确状态
* 登记日志文件
    * 日志的内容：
    * 更新数据库的事务标识（标明哪个是事务）
    * 操作的类型（插入、删除或者修改）
    * 操作对象
    * 更新前数据的旧值（插入没有旧值）
    * 更新后数据的新值（删除没有新值）
    * 事务处理中各个关键时刻（事务开始、结束及其真正回写时间）
* 数据转储：定期将数据库复制到多个存储设备（磁带、磁盘）上
    * 存储方式：海量转储和增量转储
    * 存储运行方式：静态转储和动态转储
    * 存储位置：同城和异地
* 故障及恢复
    * 事务故障：程序中的异常结束所造成的故障
        * 恢复：反向扫描日志文件，找出该事务更新操作
        * 对该事务的更新操作执行反操作
    * 系统故障：在运行过程中，由于某种原因，造成系统听自己运转，致使所有正在运行的事务都以非正常方式终止，要求系统重新启动
        * 恢复：查账尚未提交的事务，将其事务标识记入撤销队列。同时查找已提交的事务，将其事务标识记入重做队列
        * 对撤销队列中的各个事务进行撤销处理
        * 对重做队列中的各个事务进行重做处理
    * 介质故障：存储器介质受到破坏，使存储在外存中的数据部分丢失或全部丢失
        * 恢复：装入最新的转储
        * 装入最新的日志文件副本
        * 找出发生故障前已提交的事务，将其记入重做队列。再对重做队列中的各个事务进行重做处理
      ![avatar](http://118.31.20.205:8888/images/9.7.png)